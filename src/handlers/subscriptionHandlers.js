/**
 * u041eu0431u0440u0430u0431u043eu0442u0447u0438u043au0438 u043au043eu043cu0430u043du0434 u0434u043bu044f u0443u043fu0440u0430u0432u043bu0435u043du0438u044f u043fu043eu0434u043fu0438u0441u043au043eu0439
 */

const subscriptionService = require('../services/subscriptionService');

/**
 * u041eu0431u0440u0430u0431u0430u0442u044bu0432u0430u0435u0442 u043au043eu043cu0430u043du0434u0443 /subscribe
 * @param {Object} bot - u042du043au0437u0435u043cu043fu043bu044fu0440 u0431u043eu0442u0430
 * @param {Object} msg - u041eu0431u044au0435u043au0442 u0441u043eu043eu0431u0449u0435u043du0438u044f
 */
function handleSubscribe(bot, msg) {
  const chatId = msg.chat.id;
  const userId = msg.from.id.toString();
  
  // u041fu043eu043bu0443u0447u0430u0435u043c u0438u043du0444u043eu0440u043cu0430u0446u0438u044e u043e u043fu043eu0434u043fu0438u0441u043au0435
  const subscriptionInfo = subscriptionService.getSubscriptionInfo(userId);
  
  if (subscriptionInfo.isPremium) {
    // u0415u0441u043bu0438 u0443 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f u0443u0436u0435 u0435u0441u0442u044c u043fu0440u0435u043cu0438u0443u043c-u043fu043eu0434u043fu0438u0441u043au0430
    const expiryDate = new Date(subscriptionInfo.subscriptionExpiry).toLocaleDateString();
    bot.sendMessage(
      chatId,
      `u0423 u0432u0430u0441 u0443u0436u0435 u0435u0441u0442u044c u0430u043au0442u0438u0432u043du0430u044f u043fu0440u0435u043cu0438u0443u043c-u043fu043eu0434u043fu0438u0441u043au0430! u041eu043du0430 u0434u0435u0439u0441u0442u0432u0443u0435u0442 u0434u043e ${expiryDate}.`
    );
  } else {
    // u041eu0442u043fu0440u0430u0432u043bu044fu0435u043c u0438u043du0444u043eu0440u043cu0430u0446u0438u044e u043e u043fu043eu0434u043fu0438u0441u043au0435 u0438 u043au043du043eu043fu043au0443 u0434u043bu044f u043eu043fu043bu0430u0442u044b
    bot.sendMessage(
      chatId,
      `u041fu0440u0435u043cu0438u0443u043c-u043fu043eu0434u043fu0438u0441u043au0430 u043fu043eu0437u0432u043eu043bu044fu0435u0442 u0432u0430u043c u043eu0442u043fu0440u0430u0432u043bu044fu0442u044c u043du0435u043eu0433u0440u0430u043du0438u0447u0435u043du043du043eu0435 u043au043eu043bu0438u0447u0435u0441u0442u0432u043e u0437u0430u043fu0440u043eu0441u043eu0432 u043a u0431u043eu0442u0443.

u0421u0442u043eu0438u043cu043eu0441u0442u044c: $${subscriptionService.SUBSCRIPTION_PRICE} u0432 u043cu0435u0441u044fu0446

u0423 u0432u0430u0441 u043eu0441u0442u0430u043bu043eu0441u044c ${subscriptionInfo.remainingFreeRequests} u0431u0435u0441u043fu043bu0430u0442u043du044bu0445 u0437u0430u043fu0440u043eu0441u043eu0432.`,
      {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'u041eu0444u043eu0440u043cu0438u0442u044c u043fu043eu0434u043fu0438u0441u043au0443', callback_data: 'payment_subscription' }]
          ]
        }
      }
    );
  }
}

/**
 * u041eu0431u0440u0430u0431u0430u0442u044bu0432u0430u0435u0442 u043au043eu043cu0430u043du0434u0443 /status
 * @param {Object} bot - u042du043au0437u0435u043cu043fu043bu044fu0440 u0431u043eu0442u0430
 * @param {Object} msg - u041eu0431u044au0435u043au0442 u0441u043eu043eu0431u0449u0435u043du0438u044f
 */
function handleStatus(bot, msg) {
  const chatId = msg.chat.id;
  const userId = msg.from.id.toString();
  
  // u041fu043eu043bu0443u0447u0430u0435u043c u0438u043du0444u043eu0440u043cu0430u0446u0438u044e u043e u043fu043eu0434u043fu0438u0441u043au0435
  const subscriptionInfo = subscriptionService.getSubscriptionInfo(userId);
  
  if (subscriptionInfo.isPremium) {
    const expiryDate = new Date(subscriptionInfo.subscriptionExpiry).toLocaleDateString();
    bot.sendMessage(
      chatId,
      `u0421u0442u0430u0442u0443u0441 u0432u0430u0448u0435u0439 u043fu043eu0434u043fu0438u0441u043au0438:

u2705 u0423 u0432u0430u0441 u0430u043au0442u0438u0432u043du0430 u043fu0440u0435u043cu0438u0443u043c-u043fu043eu0434u043fu0438u0441u043au0430
u2705 u0412u044b u043cu043eu0436u0435u0442u0435 u043eu0442u043fu0440u0430u0432u043bu044fu0442u044c u043du0435u043eu0433u0440u0430u043du0438u0447u0435u043du043du043eu0435 u043au043eu043bu0438u0447u0435u0441u0442u0432u043e u0437u0430u043fu0440u043eu0441u043eu0432
u2705 u0421u0440u043eu043a u0434u0435u0439u0441u0442u0432u0438u044f: u0434u043e ${expiryDate}`
    );
  } else {
    bot.sendMessage(
      chatId,
      `u0421u0442u0430u0442u0443u0441 u0432u0430u0448u0435u0439 u043fu043eu0434u043fu0438u0441u043au0438:

u274c u0423 u0432u0430u0441 u043du0435u0442 u0430u043au0442u0438u0432u043du043eu0439 u043fu0440u0435u043cu0438u0443u043c-u043fu043eu0434u043fu0438u0441u043au0438
u2139ufe0f u0418u0441u043fu043eu043bu044cu0437u043eu0432u0430u043du043e u0437u0430u043fu0440u043eu0441u043eu0432: ${subscriptionInfo.requestsCount} u0438u0437 ${subscriptionService.FREE_REQUESTS_LIMIT}
u2139ufe0f u041eu0441u0442u0430u043bu043eu0441u044c u0431u0435u0441u043fu043bu0430u0442u043du044bu0445 u0437u0430u043fu0440u043eu0441u043eu0432: ${subscriptionInfo.remainingFreeRequests}

u0427u0442u043eu0431u044b u043eu0444u043eu0440u043cu0438u0442u044c u043fu043eu0434u043fu0438u0441u043au0443, u0438u0441u043fu043eu043bu044cu0437u0443u0439u0442u0435 u043au043eu043cu0430u043du0434u0443 /subscribe`,
      {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'u041eu0444u043eu0440u043cu0438u0442u044c u043fu043eu0434u043fu0438u0441u043au0443', callback_data: 'payment_subscription' }]
          ]
        }
      }
    );
  }
}

/**
 * u041eu0431u0440u0430u0431u0430u0442u044bu0432u0430u0435u0442 u043du0430u0436u0430u0442u0438u0435 u043du0430 u043au043du043eu043fu043au0443 u043eu043fu043bu0430u0442u044b
 * @param {Object} bot - u042du043au0437u0435u043cu043fu043bu044fu0440 u0431u043eu0442u0430
 * @param {Object} callbackQuery - u041eu0431u044au0435u043au0442 callback query
 */
function handlePaymentCallback(bot, callbackQuery) {
  const chatId = callbackQuery.message.chat.id;
  const userId = callbackQuery.from.id.toString();
  
  // u041eu0442u0432u0435u0447u0430u0435u043c u043du0430 callback query
  bot.answerCallbackQuery(callbackQuery.id);
  
  // u0412 u0440u0435u0430u043bu044cu043du043eu043c u043fu0440u0438u043bu043eu0436u0435u043du0438u0438 u0437u0434u0435u0441u044c u0431u044bu043bu0430 u0431u044b u0438u043du0442u0435u0433u0440u0430u0446u0438u044f u0441 u043fu043bu0430u0442u0435u0436u043du043eu0439 u0441u0438u0441u0442u0435u043cu043eu0439
  // u0414u043bu044f u0434u0435u043cu043eu043du0441u0442u0440u0430u0446u0438u0438 u043fu0440u043eu0441u0442u043e u0430u043au0442u0438u0432u0438u0440u0443u0435u043c u043fu0440u0435u043cu0438u0443u043c-u043fu043eu0434u043fu0438u0441u043au0443
  
  // u0421u043eu0437u0434u0430u0435u043c u0438u043du0432u043eu0439u0441 u0434u043bu044f u043eu043fu043bu0430u0442u044b
  bot.sendMessage(
    chatId,
    `u0414u043bu044f u043eu0444u043eu0440u043cu043bu0435u043du0438u044f u043fu043eu0434u043fu0438u0441u043au0438 u043du0435u043eu0431u0445u043eu0434u0438u043cu043e u043eu043fu043bu0430u0442u0438u0442u044c $${subscriptionService.SUBSCRIPTION_PRICE}.

u0412 u0440u0435u0430u043bu044cu043du043eu043c u043fu0440u0438u043bu043eu0436u0435u043du0438u0438 u0437u0434u0435u0441u044c u0431u044bu043bu0430 u0431u044b u0444u043eu0440u043cu0430 u043eu043fu043bu0430u0442u044b.

u0414u043bu044f u0434u0435u043cu043eu043du0441u0442u0440u0430u0446u0438u0438 u043du0430u0436u043cu0438u0442u0435 u043au043du043eu043fu043au0443 u043du0438u0436u0435, u0447u0442u043eu0431u044b u0430u043au0442u0438u0432u0438u0440u043eu0432u0430u0442u044c u043fu0440u0435u043cu0438u0443u043c-u043fu043eu0434u043fu0438u0441u043au0443:`,
    {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'u0418u043cu0438u0442u0438u0440u043eu0432u0430u0442u044c u043eu043fu043bu0430u0442u0443', callback_data: 'simulate_payment' }]
        ]
      }
    }
  );
}

/**
 * u041eu0431u0440u0430u0431u0430u0442u044bu0432u0430u0435u0442 u0438u043cu0438u0442u0430u0446u0438u044e u043eu043fu043bu0430u0442u044b
 * @param {Object} bot - u042du043au0437u0435u043cu043fu043bu044fu0440 u0431u043eu0442u0430
 * @param {Object} callbackQuery - u041eu0431u044au0435u043au0442 callback query
 */
function handleSimulatePayment(bot, callbackQuery) {
  const chatId = callbackQuery.message.chat.id;
  const userId = callbackQuery.from.id.toString();
  
  // u041eu0442u0432u0435u0447u0430u0435u043c u043du0430 callback query
  bot.answerCallbackQuery(callbackQuery.id, { text: 'u041eu043fu043bu0430u0442u0430 u043fu0440u043eu0448u043bu0430 u0443u0441u043fu0435u0448u043du043e!' });
  
  // u0410u043au0442u0438u0432u0438u0440u0443u0435u043c u043fu0440u0435u043cu0438u0443u043c-u043fu043eu0434u043fu0438u0441u043au0443
  subscriptionService.activatePremium(userId);
  
  // u041eu0442u043fu0440u0430u0432u043bu044fu0435u043c u0441u043eu043eu0431u0449u0435u043du0438u0435 u043eu0431 u0443u0441u043fu0435u0448u043du043eu0439 u0430u043au0442u0438u0432u0430u0446u0438u0438
  const subscriptionInfo = subscriptionService.getSubscriptionInfo(userId);
  const expiryDate = new Date(subscriptionInfo.subscriptionExpiry).toLocaleDateString();
  
  bot.sendMessage(
    chatId,
    `u2705 u041fu043eu0437u0434u0440u0430u0432u043bu044fu0435u043c! u0412u0430u0448u0430 u043fu0440u0435u043cu0438u0443u043c-u043fu043eu0434u043fu0438u0441u043au0430 u0430u043au0442u0438u0432u0438u0440u043eu0432u0430u043du0430.

u0422u0435u043fu0435u0440u044c u0432u044b u043cu043eu0436u0435u0442u0435 u043eu0442u043fu0440u0430u0432u043bu044fu0442u044c u043du0435u043eu0433u0440u0430u043du0438u0447u0435u043du043du043eu0435 u043au043eu043bu0438u0447u0435u0441u0442u0432u043e u0437u0430u043fu0440u043eu0441u043eu0432 u043a u0431u043eu0442u0443.

u0421u0440u043eu043a u0434u0435u0439u0441u0442u0432u0438u044f u043fu043eu0434u043fu0438u0441u043au0438: u0434u043e ${expiryDate}`
  );
}

/**
 * u041eu0442u043fu0440u0430u0432u043bu044fu0435u0442 u0441u043eu043eu0431u0449u0435u043du0438u0435 u043e u043du0435u043eu0431u0445u043eu0434u0438u043cu043eu0441u0442u0438 u043eu0444u043eu0440u043cu0438u0442u044c u043fu043eu0434u043fu0438u0441u043au0443
 * @param {Object} bot - u042du043au0437u0435u043cu043fu043bu044fu0440 u0431u043eu0442u0430
 * @param {number} chatId - ID u0447u0430u0442u0430
 */
function sendSubscriptionRequiredMessage(bot, chatId) {
  bot.sendMessage(
    chatId,
    `u2757 u0412u044b u0438u0441u0447u0435u0440u043fu0430u043bu0438 u043bu0438u043cu0438u0442 u0431u0435u0441u043fu043bu0430u0442u043du044bu0445 u0437u0430u043fu0440u043eu0441u043eu0432 (${subscriptionService.FREE_REQUESTS_LIMIT}).

u0414u043bu044f u043fu0440u043eu0434u043eu043bu0436u0435u043du0438u044f u0440u0430u0431u043eu0442u044b u0441 u0431u043eu0442u043eu043c u043du0435u043eu0431u0445u043eu0434u0438u043cu043e u043eu0444u043eu0440u043cu0438u0442u044c u043fu0440u0435u043cu0438u0443u043c-u043fu043eu0434u043fu0438u0441u043au0443.

u0421u0442u043eu0438u043cu043eu0441u0442u044c: $${subscriptionService.SUBSCRIPTION_PRICE} u0432 u043cu0435u0441u044fu0446`,
    {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'u041eu0444u043eu0440u043cu0438u0442u044c u043fu043eu0434u043fu0438u0441u043au0443', callback_data: 'payment_subscription' }]
        ]
      }
    }
  );
}

module.exports = {
  handleSubscribe,
  handleStatus,
  handlePaymentCallback,
  handleSimulatePayment,
  sendSubscriptionRequiredMessage
};

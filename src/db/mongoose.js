/**
 * u041cu043eu0434u0443u043bu044c u0434u043bu044f u043fu043eu0434u043au043bu044eu0447u0435u043du0438u044f u043a MongoDB
 */
const mongoose = require('mongoose');
require('dotenv').config();

// u041fu043eu043bu0443u0447u0430u0435u043c URI u0434u043bu044f u043fu043eu0434u043au043bu044eu0447u0435u043du0438u044f u043a MongoDB u0438u0437 u043fu0435u0440u0435u043cu0435u043du043du044bu0445 u043eu043au0440u0443u0436u0435u043du0438u044f
const MONGODB_URI = process.env.MONGODB_URI || 'mongodb://localhost:27017/telegram-bot';

/**
 * u0423u0441u0442u0430u043du0430u0432u043bu0438u0432u0430u0435u0442 u0441u043eu0435u0434u0438u043du0435u043du0438u0435 u0441 MongoDB
 * @returns {Promise} u041fu0440u043eu043cu0438u0441, u043au043eu0442u043eu0440u044bu0439 u0440u0430u0437u0440u0435u0448u0430u0435u0442u0441u044f u043fu043eu0441u043bu0435 u0443u0441u0442u0430u043du043eu0432u043au0438 u0441u043eu0435u0434u0438u043du0435u043du0438u044f
 */
async function connectToDatabase() {
  try {
    // u041du0430u0441u0442u0440u043eu0439u043au0438 u0441u043eu0435u0434u0438u043du0435u043du0438u044f
    const options = {
      useNewUrlParser: true,
      useUnifiedTopology: true,
    };

    // u0423u0441u0442u0430u043du0430u0432u043bu0438u0432u0430u0435u043c u0441u043eu0435u0434u0438u043du0435u043du0438u0435
    await mongoose.connect(MONGODB_URI, options);
    console.log('u0423u0441u043fu0435u0448u043du043eu0435 u043fu043eu0434u043au043bu044eu0447u0435u043du0438u0435 u043a MongoDB');

    // u041eu0431u0440u0430u0431u043eu0442u0447u0438u043a u0441u043eu0431u044bu0442u0438u044f u043eu0448u0438u0431u043au0438
    mongoose.connection.on('error', (err) => {
      console.error('u041eu0448u0438u0431u043au0430 u0441u043eu0435u0434u0438u043du0435u043du0438u044f u0441 MongoDB:', err);
    });

    // u041eu0431u0440u0430u0431u043eu0442u0447u0438u043a u0441u043eu0431u044bu0442u0438u044f u043eu0442u043au043bu044eu0447u0435u043du0438u044f
    mongoose.connection.on('disconnected', () => {
      console.log('u041eu0442u043au043bu044eu0447u0435u043du0438u0435 u043eu0442 MongoDB');
    });

    // u041au043eu0440u0440u0435u043au0442u043du043eu0435 u0437u0430u0432u0435u0440u0448u0435u043du0438u0435 u0441u043eu0435u0434u0438u043du0435u043du0438u044f u043fu0440u0438 u0437u0430u0432u0435u0440u0448u0435u043du0438u0438 u043fu0440u043eu0446u0435u0441u0441u0430
    process.on('SIGINT', async () => {
      await mongoose.connection.close();
      console.log('u0421u043eu0435u0434u0438u043du0435u043du0438u0435 u0441 MongoDB u0437u0430u043au0440u044bu0442u043e u0438u0437-u0437u0430 u0437u0430u0432u0435u0440u0448u0435u043du0438u044f u043fu0440u0438u043bu043eu0436u0435u043du0438u044f');
      process.exit(0);
    });

    return mongoose.connection;
  } catch (error) {
    console.error('u041eu0448u0438u0431u043au0430 u043fu0440u0438 u043fu043eu0434u043au043bu044eu0447u0435u043du0438u0438 u043a MongoDB:', error);
    throw error;
  }
}

module.exports = {
  connectToDatabase,
  connection: mongoose.connection
};

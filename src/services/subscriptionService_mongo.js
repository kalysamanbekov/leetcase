/**
 * u0421u0435u0440u0432u0438u0441 u0434u043bu044f u0440u0430u0431u043eu0442u044b u0441 u043fu043eu0434u043fu0438u0441u043au0430u043cu0438 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu0435u0439 u0441 u0438u0441u043fu043eu043bu044cu0437u043eu0432u0430u043du0438u0435u043c MongoDB
 */

// u0418u043cu043fu043eu0440u0442u0438u0440u0443u0435u043c u043cu043eu0434u0435u043bu044c u043fu043eu0434u043fu0438u0441u043au0438
const Subscription = require('../models/Subscription');

// u041bu0438u043cu0438u0442 u0431u0435u0441u043fu043bu0430u0442u043du044bu0445 u0437u0430u043fu0440u043eu0441u043eu0432
const FREE_REQUESTS_LIMIT = 10;

/**
 * u041fu0440u043eu0432u0435u0440u044fu0435u0442, u043cu043eu0436u0435u0442 u043bu0438 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044c u043eu0442u043fu0440u0430u0432u0438u0442u044c u0437u0430u043fu0440u043eu0441
 * @param {string} userId - ID u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f
 * @returns {Promise<boolean>} - u041cu043eu0436u0435u0442 u043bu0438 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044c u043eu0442u043fu0440u0430u0432u0438u0442u044c u0437u0430u043fu0440u043eu0441
 */
async function canSendRequest(userId) {
  try {
    // u041fu043eu043bu0443u0447u0430u0435u043c u0434u0430u043du043du044bu0435 u043e u043fu043eu0434u043fu0438u0441u043au0435 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f
    let subscription = await Subscription.findOne({ userId });
    
    // u0415u0441u043bu0438 u043fu043eu0434u043fu0438u0441u043au0438 u043du0435u0442, u0441u043eu0437u0434u0430u0435u043c u043du043eu0432u0443u044e
    if (!subscription) {
      subscription = await initUserSubscription(userId);
    }
    
    // u041fu0440u043eu0432u0435u0440u044fu0435u043c, u0435u0441u0442u044c u043bu0438 u0443 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f u043fu0440u0435u043cu0438u0443u043c-u043fu043eu0434u043fu0438u0441u043au0430
    if (subscription.isPremium) {
      // u041fu0440u043eu0432u0435u0440u044fu0435u043c, u043du0435 u0438u0441u0442u0435u043au043bu0430 u043bu0438 u043fu043eu0434u043fu0438u0441u043au0430
      if (subscription.subscriptionExpiry && new Date() > subscription.subscriptionExpiry) {
        // u0415u0441u043bu0438 u043fu043eu0434u043fu0438u0441u043au0430 u0438u0441u0442u0435u043au043bu0430, u0441u0431u0440u0430u0441u044bu0432u0430u0435u043c u0444u043bu0430u0433 u043fu0440u0435u043cu0438u0443u043c
        subscription.isPremium = false;
        subscription.subscriptionExpiry = null;
        await subscription.save();
        
        // u041fu0440u043eu0432u0435u0440u044fu0435u043c u043bu0438u043cu0438u0442 u0431u0435u0441u043fu043bu0430u0442u043du044bu0445 u0437u0430u043fu0440u043eu0441u043eu0432
        return subscription.requestsCount < FREE_REQUESTS_LIMIT;
      }
      
      // u0415u0441u043bu0438 u043fu043eu0434u043fu0438u0441u043au0430 u0430u043au0442u0438u0432u043du0430, u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044c u043cu043eu0436u0435u0442 u043eu0442u043fu0440u0430u0432u043bu044fu0442u044c u0437u0430u043fu0440u043eu0441u044b
      return true;
    }
    
    // u0414u043bu044f u043eu0431u044bu0447u043du044bu0445 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu0435u0439 u043fu0440u043eu0432u0435u0440u044fu0435u043c u043bu0438u043cu0438u0442 u0431u0435u0441u043fu043bu0430u0442u043du044bu0445 u0437u0430u043fu0440u043eu0441u043eu0432
    return subscription.requestsCount < FREE_REQUESTS_LIMIT;
  } catch (error) {
    console.error('u041eu0448u0438u0431u043au0430 u043fu0440u0438 u043fu0440u043eu0432u0435u0440u043au0435 u0432u043eu0437u043cu043eu0436u043du043eu0441u0442u0438 u043eu0442u043fu0440u0430u0432u043au0438 u0437u0430u043fu0440u043eu0441u0430:', error);
    // u0412 u0441u043bu0443u0447u0430u0435 u043eu0448u0438u0431u043au0438 u0440u0430u0437u0440u0435u0448u0430u0435u043c u043eu0442u043fu0440u0430u0432u043au0443 u0437u0430u043fu0440u043eu0441u0430
    return true;
  }
}

/**
 * u0418u043du0438u0446u0438u0430u043bu0438u0437u0438u0440u0443u0435u0442 u043fu043eu0434u043fu0438u0441u043au0443 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f
 * @param {string} userId - ID u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f
 * @returns {Promise<Object>} - u041eu0431u044au0435u043au0442 u043fu043eu0434u043fu0438u0441u043au0438
 */
async function initUserSubscription(userId) {
  try {
    // u0421u043eu0437u0434u0430u0435u043c u043du043eu0432u0443u044e u043fu043eu0434u043fu0438u0441u043au0443
    const subscription = new Subscription({
      userId,
      requestsCount: 0,
      isPremium: false,
      subscriptionExpiry: null
    });
    
    // u0421u043eu0445u0440u0430u043du044fu0435u043c u0432 u0431u0430u0437u0443 u0434u0430u043du043du044bu0445
    await subscription.save();
    
    return subscription;
  } catch (error) {
    console.error('u041eu0448u0438u0431u043au0430 u043fu0440u0438 u0438u043du0438u0446u0438u0430u043bu0438u0437u0430u0446u0438u0438 u043fu043eu0434u043fu0438u0441u043au0438 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f:', error);
    throw error;
  }
}

/**
 * u0420u0435u0433u0438u0441u0442u0440u0438u0440u0443u0435u0442 u0437u0430u043fu0440u043eu0441 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f
 * @param {string} userId - ID u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f
 * @returns {Promise<Object>} - u041eu0431u043du043eu0432u043bu0435u043du043du044bu0439 u043eu0431u044au0435u043au0442 u043fu043eu0434u043fu0438u0441u043au0438
 */
async function registerRequest(userId) {
  try {
    // u041fu043eu043bu0443u0447u0430u0435u043c u0434u0430u043du043du044bu0435 u043e u043fu043eu0434u043fu0438u0441u043au0435 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f
    let subscription = await Subscription.findOne({ userId });
    
    // u0415u0441u043bu0438 u043fu043eu0434u043fu0438u0441u043au0438 u043du0435u0442, u0441u043eu0437u0434u0430u0435u043c u043du043eu0432u0443u044e
    if (!subscription) {
      subscription = await initUserSubscription(userId);
    }
    
    // u0423u0432u0435u043bu0438u0447u0438u0432u0430u0435u043c u0441u0447u0435u0442u0447u0438u043a u0437u0430u043fu0440u043eu0441u043eu0432
    subscription.requestsCount += 1;
    
    // u0421u043eu0445u0440u0430u043du044fu0435u043c u0438u0437u043cu0435u043du0435u043du0438u044f
    await subscription.save();
    
    return subscription;
  } catch (error) {
    console.error('u041eu0448u0438u0431u043au0430 u043fu0440u0438 u0440u0435u0433u0438u0441u0442u0440u0430u0446u0438u0438 u0437u0430u043fu0440u043eu0441u0430:', error);
    throw error;
  }
}

/**
 * u041fu043eu043bu0443u0447u0430u0435u0442 u0438u043du0444u043eu0440u043cu0430u0446u0438u044e u043e u043fu043eu0434u043fu0438u0441u043au0435 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f
 * @param {string} userId - ID u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f
 * @returns {Promise<Object>} - u0418u043du0444u043eu0440u043cu0430u0446u0438u044f u043e u043fu043eu0434u043fu0438u0441u043au0435
 */
async function getUserSubscription(userId) {
  try {
    // u041fu043eu043bu0443u0447u0430u0435u043c u0434u0430u043du043du044bu0435 u043e u043fu043eu0434u043fu0438u0441u043au0435 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f
    let subscription = await Subscription.findOne({ userId });
    
    // u0415u0441u043bu0438 u043fu043eu0434u043fu0438u0441u043au0438 u043du0435u0442, u0441u043eu0437u0434u0430u0435u043c u043du043eu0432u0443u044e
    if (!subscription) {
      subscription = await initUserSubscription(userId);
    }
    
    return {
      userId: subscription.userId,
      requestsCount: subscription.requestsCount,
      isPremium: subscription.isPremium,
      subscriptionExpiry: subscription.subscriptionExpiry,
      remainingFreeRequests: Math.max(0, FREE_REQUESTS_LIMIT - subscription.requestsCount)
    };
  } catch (error) {
    console.error('u041eu0448u0438u0431u043au0430 u043fu0440u0438 u043fu043eu043bu0443u0447u0435u043du0438u0438 u0438u043du0444u043eu0440u043cu0430u0446u0438u0438 u043e u043fu043eu0434u043fu0438u0441u043au0435:', error);
    throw error;
  }
}

module.exports = {
  canSendRequest,
  registerRequest,
  getUserSubscription,
  FREE_REQUESTS_LIMIT
};
